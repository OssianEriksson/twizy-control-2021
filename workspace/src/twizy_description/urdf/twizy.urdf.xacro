<?xml version="1.0"?>

<robot name="twizy"
    xmlns:xacro="http://ros.org/wiki/xacro">
    <xacro:property name="yaml_file" value="$(find twizy_description)/config/robot_properties.yaml" />
    <xacro:property name="props" value="${load_yaml(yaml_file)}"/>

    <xacro:macro name="fixed_joint" params="parent:=ground_centered child xyz:='0 0 0' rpy:='0 0 0'">
        <joint name="${child}_joint" type="fixed">
            <parent link="${parent}" />
            <child link="${child}" />
            <origin xyz="${xyz}" rpy="${rpy}" />
        </joint>
    </xacro:macro>

    <xacro:macro name="fixed_link" params="link parent:=ground_centered xyz:='0 0 0' rpy:='0 0 0'">
        <link name="${link}" />
        <xacro:fixed_joint parent="${parent}" child="${link}" xyz="${xyz}" rpy="${rpy}" />
    </xacro:macro>

    <xacro:macro name="wheel" params="prefix xyz rpy parent">
        <link name="${prefix}_wheel">
            <visual>
                <geometry>
                    <cylinder length="${props['wheel']['width']}" radius="${props['wheel']['radius']}"/>
                </geometry>
            </visual>
        </link>
        <joint name="${prefix}_wheel_joint" type="continuous">
            <origin xyz="${xyz}" rpy="${rpy}" />
            <parent link="${parent}" />
            <child link="${prefix}_wheel" />
            <axis xyz="0 0 1" />
        </joint>
    </xacro:macro>

    <xacro:macro name="steerable_wheel" params="prefix xyz steering_rpy wheel_rpy parent">
        <link name="${prefix}_hinge" />
        <joint name="${prefix}_hinge_joint" type="revolute">
            <origin xyz="${xyz}" rpy="${steering_rpy}" />
            <parent link="${parent}" />
            <child link="${prefix}_hinge" />
            <axis xyz="0 0 1" />
            <limit lower="${-props['wheel']['max_steering_angle']}" upper="${props['wheel']['max_steering_angle']}" effort="${props['wheel']['max_steering_effort']}" velocity="${props['wheel']['max_velocity']/props['wheel']['radius']}" />
        </joint>
        <xacro:wheel prefix="${prefix}" xyz="0 0 0" rpy="${wheel_rpy}" parent="${prefix}_hinge" />
    </xacro:macro>

    <link name="base_link" />

    <xacro:property name="scale_vec" value="${lambda v, scale: dict((i, scale*a) for i, a in v.items())}" />
    <xacro:property name="vec2str" value="${lambda v: '%.15g %.15g %.15g' % (v['x'], v['y'], v['z'])}" />

    <xacro:fixed_link link="ground_centered" parent="base_link" xyz="${-props['gnss']['x']} 0 ${-props['gnss']['z']}" />

    <xacro:fixed_link link="front_realsense" xyz="${vec2str(props['front_realsense']['translation'])}" rpy="0 ${props['front_realsense']['rotation']['pitch']} 0" />

    <link name="chassis">
        <visual>
            <geometry>
                <box size="${props['chassis']['wheelbase']} ${props['chassis']['track']} ${props['chassis']['height']}" />
            </geometry>
        </visual>
    </link>
    <xacro:fixed_joint child="chassis" xyz="0 0 ${props['wheel']['radius'] + props['chassis']['height'] / 2}" />

    <xacro:steerable_wheel prefix="front_left" xyz="${props['chassis']['wheelbase']/2.0} ${props['chassis']['track']/2.0} ${props['wheel']['radius']}" steering_rpy="0 0 0" wheel_rpy="${pi/2.0} 0 0" parent="ground_centered" />
    <xacro:steerable_wheel prefix="front_right" xyz="${props['chassis']['wheelbase']/2.0} ${-props['chassis']['track']/2.0} ${props['wheel']['radius']}" steering_rpy="0 0 0" wheel_rpy="${-pi/2.0} 0 0" parent="ground_centered" />
    <xacro:wheel prefix="rear_left" xyz="${-props['chassis']['wheelbase']/2.0} ${props['chassis']['track']/2.0} ${props['wheel']['radius']}" rpy="${pi/2.0} 0 0" parent="ground_centered" />
    <xacro:wheel prefix="rear_right" xyz="${-props['chassis']['wheelbase']/2.0} ${-props['chassis']['track']/2.0} ${props['wheel']['radius']}" rpy="${-pi/2.0} 0 0" parent="ground_centered" />

</robot>